<!-- STARTING EXAMPLE: https://bl.ocks.org/gcalmettes/95e3553da26ec90fd0a2890a678f3f69 -->
<!-- Excel formula for some of the dates: =TEXT(MID(F39,4,2),"##")&"/"&LEFT(F39,2)&"/"&RIGHT(F39,4) -->
<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://code.jquery.com/jquery.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<style>

.enter {
  /*fill: #EDCA3A;*/
  fill:#7997c6;
}

/*.update {
  fill: #1FBAD6;
}

.exit {
  fill: #F25754;
}*/

.selected {
  fill: #E6B0F1;
}

div {
    text-align:center;
}

div.tooltip {
  color: black;
  position: absolute;
  text-align: left;
  width: auto;
  height: auto;
  padding: 5px;
  font-family: Futura;
  font: 1em sans-serif ;
  background: #E6B0F1;
  border: 0px;
  border-radius: 8px;
  pointer-events: none;
}

.button {
    background-color: #2c75be; 
    border: none;
    color: white;
    padding: 10px 24px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    -webkit-transition-duration: 0.1s; /* Safari */
    transition-duration: 0.1s;
    margin: .5em .5em;
}

.button:hover {
    background-color: #7997c6;
    color: white;
}

.button:focus {
    background-color: #7997c6;
    color: white;
}

body {
    background-color: black;
}

.axis--x line{
  stroke: white;
}

.axis--x path{
  stroke: white;
}

.axis--x text{
  fill: white;
} 

#title {
  color: white;
  padding: 5px;
  font-family: Futura;
  font: 2em sans-serif ;
}

#intro {
  color: white;
  padding: 5px;
  font-family: Futura;
  font: 1em sans-serif ;
  text-align:center;
} 

#cite {
  color: white;
  padding: 5px;
  font-family: Futura;
  font: .8em sans-serif ;
  text-align:left;
}  

</style>


<body>
<div class = "row">
  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id = "title" align=center>TDoR 2017</div>
</div>
<div class = "row">
  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id = "intro" align=center>325 reported murders of trans and gender-diverse people between October 1, 2016 and September 30, 2017</div>
</div>
<div class="row">
    <button class = "button" onclick="update('Africa')">
        Africa
    </button>
    <button class = "button" onclick="update('Asia')">
        Asia
    </button>
    <button class = "button" onclick="update('Europe')">
        Europe
    </button>
    <button class = "button" onclick="update('North America')">
        North America
    </button>
    <button class = "button" onclick="update('Oceania')">
        Oceania
    </button>
    <button class = "button" onclick="update('South America')">
        South America
    </button>
    <button class = "button" onclick="update('All')">
        All
    </button>
</div>
<div class = "row">
  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id = "chart" align=center></div>
</div>
<div class = "row">
  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id = "cite" align=left style="white-space: pre-wrap;">N.N. = Not Named &#10;Data from TvT research project (2017) “Trans Murder Monitoring (TMM) TDoR 2017 Update”, Transrespect versus Transphobia Worldwide &#10;TvT project website: http://transrespect.org/en/trans-murder-monitoring/tmm-resources</div>
</div>

<script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/D5E5001F-AA7E-4E47-8C5F-BD52C68CD6AE/main.js" charset="UTF-8"></script><script src="https://d3js.org/d3.v4.min.js"></script>
<script>

//SVG setup
const margin = {top: 10, right: 30, bottom: 30, left: 30},
      width = 600 - margin.left - margin.right,
      height = 200 - margin.top - margin.bottom;

// Custome time format
var formatMillisecond = d3.timeFormat(".%L"),
    formatSecond = d3.timeFormat(":%S"),
    formatMinute = d3.timeFormat("%I:%M"),
    formatHour = d3.timeFormat("%I %p"),
    formatDay = d3.timeFormat("%a %d"),
    formatWeek = d3.timeFormat("%b %d"),
    formatMonth = d3.timeFormat("%b"),
    formatYear = d3.timeFormat("%Y");
function multiFormat(date) {
  return (d3.timeSecond(date) < date ? formatMillisecond
      : d3.timeMinute(date) < date ? formatSecond
      : d3.timeHour(date) < date ? formatMinute
      : d3.timeDay(date) < date ? formatHour
      : d3.timeMonth(date) < date ? (d3.timeWeek(date) < date ? formatDay : formatWeek)
      : d3.timeYear(date) < date ? formatMonth
      : formatYear)(date);
}

// Parse function for date
var parseTime = d3.timeParse("%m/%d/%y");
var formatTime = d3.timeFormat("%m/%d/%y");

//set up svg
// const svg = d3.select("body")
//   .append("svg")
var svg = d3.select("#chart").append("svg")
  .attr("preserveAspectRatio", "xMinYMin meet")
  .attr("viewBox", "0 0 600 200")
  //.attr("width", width + margin.left + margin.right)
  //.attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform",`translate(${margin.left}, ${margin.top})`);

//tooltip
const tooltip = d3.select("body")
  .append("div")
  .attr("class", "tooltip")
  .style("opacity", 0);

const t = d3.transition().duration(1000);

const dataFile = "data/parsed.csv"

// Define x axis (doesnt change)
var x2 = d3.scaleTime()
           .domain([new Date(2015,8,27), new Date(2016,9,1)])
           .rangeRound([0, width]);

//Note: data fetching is done each time the function is ran
//as d3.csv is replaced by tabletop.js request to get data each time
//from google spreadsheet

function update(continent){
  // Get the data
  d3.csv(dataFile, function(error, allData) {
    if (error) throw error;
    allData.forEach(function(d) {
      //d.cause = d.cause
      //d.continent = d.continent
      d.date = parseTime(d.date);
    });


    // Filtered Data
    if (continent == 'All') {
      var data = allData;
    }
    else {
      var data = allData.filter(function(d) { return d.continent == continent});
    }
  
    console.log(data)

    // Determine the first and last dates in the data set
    var dayExtent = d3.extent(allData, function (d) { return d.date; });

    console.log(dayExtent);

    // Create one bin per week, use offset for full weeks
    var weekBins = d3.timeWeeks(dayExtent[0],dayExtent[1]);

    //histogram binning
    const histogram = d3.histogram()
              .value(function(d) { return d.date; })
              .domain(x2.domain())
              .thresholds(x2.ticks(weekBins.length));

    //binning data
    const bins = histogram(data)

    console.log(bins)

    //g container for each bin
    let binContainer = svg.selectAll(".gBin")
      .data(bins);

    binContainer.exit().remove()

    let binContainerEnter = binContainer.enter()
        .append("g")
        .attr("class", "gBin")
        .attr("transform", d => `translate(${x2(d.x0)}, ${height})`)

    //need to populate the bin containers with data the first time
    binContainerEnter.selectAll("circle")
        .data(d => d.map((p, i) => {
          return {idx: i,
                  name: p.name,
                  date: formatTime(p.date),
                  age: p.age,
                  cause: p.cause,
                  location: p.location,
                  remarks: p.remarks,
                  radius: 5
                  //radius: (x2(d.x1)-x2(d.x0))/2
                }
        }))
      .enter()
      .append("circle")
        .attr("class", "enter")
        .attr("cx", 0) //g element already at correct x pos
        .attr("cy", function(d) {
            return - d.idx * 2 * d.radius - d.radius; })
        .attr("r", 0)
        .on("mouseover", tooltipOn)
        .on("mouseout", tooltipOff)
        .transition()
        .duration(500)
        .attr("r", function(d) {
            return (d.length==0) ? 0 : d.radius; })

    binContainerEnter.merge(binContainer)
        .attr("transform", d => `translate(${x2(d.x0)}, ${height})`)

    //enter/update/exit for circles, inside each container
    let dots = binContainer.selectAll("circle")
        .data(d => d.map((p, i) => {
          return {idx: i,
                  name: p.name,
                  date: formatTime(p.date),
                  age: p.age,
                  cause: p.cause,
                  location: p.location,
                  remarks: p.remarks,
                  //radius: (x2(d.x1)-x2(d.x0))/2
                  radius: 5
                }
        }))

    //EXIT old elements not present in data
    dots.exit()
      //.attr("class", "exit")
      .transition(t)
      .attr("r", 0)
      .remove();

    //UPDATE old elements present in new data.
    //dots.attr("class", "update");

    //ENTER new elements present in new data.
    dots.enter()
      .append("circle")
      .attr("class", "enter")
      .attr("cx", 0) //g element already at correct x pos
      .attr("cy", function(d) {
          return - d.idx * 2 * d.radius - d.radius; })
      .attr("r", 0)
      .merge(dots)
      .on("mouseover", tooltipOn)
      .on("mouseout", tooltipOff)
      .transition()
      .duration(500)
      .attr("r", function(d) {
          return (d.length==0) ? 0 : d.radius; })
  });//d3.csv
};//update

function tooltipOn(d) {
  //x position of parent g element
  let gParent = d3.select(this.parentElement)
  let translateValue = gParent.attr("transform")

  let gX = translateValue.split(",")[0].split("(")[1]
  let gY = height + (+d3.select(this).attr("cy")+100)
  //let gY = 150

  d3.select(this)
    .classed("selected", true)
  tooltip.transition()
    .duration(200)
    .style("opacity", .9);
  tooltip.html("<strong>" + d.name + "</strong>" + "<br/> " + "Age " + d.age + "<br/> " + d.date + "<br/> " + d.location + "<br/> " + d.remarks)
    .style("left", gX + "px")
    .style("top", gY + "px");
}//tooltipOn

function tooltipOff(d) {
  d3.select(this)
      .classed("selected", false);
    tooltip.transition()
      .duration(500)
      .style("opacity", 0);
}//tooltipOff

// Add x axis
var x2Axis = d3.axisBottom(x2)
               .tickFormat(multiFormat);

svg.append("g")
   .attr("class", "axis--x")
   .attr("transform", "translate(0," + height + ")")
   .call(x2Axis);

//draw everything
update('All');

</script>

</body>
</html>